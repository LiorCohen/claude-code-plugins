/**
 * Unit Tests: settings defaults
 *
 * WHY: Default settings are used when creating new components. Incorrect
 * defaults would result in broken scaffolding or invalid configurations.
 */

import { describe, expect, it } from 'vitest';
import { PLUGIN_DIR, joinPath, readFile } from '@/lib';

const DEFAULTS_PATH = joinPath(
  PLUGIN_DIR,
  'system',
  'src',
  'settings',
  'defaults.ts'
);

/**
 * WHY: Verify the source file exists and exports expected defaults.
 */
describe('defaults.ts source file', () => {
  it('exists in plugin system/src/settings', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toBeDefined();
    expect(content.length).toBeGreaterThan(0);
  });

  it('exports DEFAULT_API_SERVER_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_API_SERVER_SETTINGS');
    expect(content).toContain("server_type: 'api'");
  });

  it('exports DEFAULT_WORKER_SERVER_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_WORKER_SERVER_SETTINGS');
    expect(content).toContain("server_type: 'worker'");
  });

  it('exports DEFAULT_HYBRID_SERVER_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_HYBRID_SERVER_SETTINGS');
    expect(content).toContain("server_type: 'hybrid'");
    expect(content).toContain("modes: ['api', 'worker']");
  });

  it('exports DEFAULT_WEBAPP_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_WEBAPP_SETTINGS');
    expect(content).toContain('contracts: []');
    expect(content).toContain('helm: true');
  });

  it('exports DEFAULT_HELM_SERVER_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_HELM_SERVER_SETTINGS');
    expect(content).toContain("deploy_type: 'server'");
    expect(content).toContain('ingress: true');
  });

  it('exports DEFAULT_HELM_WEBAPP_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_HELM_WEBAPP_SETTINGS');
    expect(content).toContain("deploy_type: 'webapp'");
    expect(content).toContain("assets: 'bundled'");
  });

  it('exports DEFAULT_DATABASE_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_DATABASE_SETTINGS');
    expect(content).toContain("provider: 'postgresql'");
    expect(content).toContain('dedicated: false');
  });

  it('exports DEFAULT_CONTRACT_SETTINGS', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const DEFAULT_CONTRACT_SETTINGS');
    expect(content).toContain("visibility: 'internal'");
  });

  it('exports getDefaultServerSettings function', () => {
    const content = readFile(DEFAULTS_PATH);
    expect(content).toContain('export const getDefaultServerSettings');
  });
});

/**
 * WHY: Verify default values are appropriate.
 */
describe('default value appropriateness', () => {
  const content = readFile(DEFAULTS_PATH);

  it('server defaults have empty arrays for references', () => {
    // All server defaults should have empty arrays to avoid invalid references
    expect(content).toContain('databases: []');
    expect(content).toContain('provides_contracts: []');
    expect(content).toContain('consumes_contracts: []');
  });

  it('webapp defaults have empty contracts array', () => {
    expect(content).toContain('contracts: []');
  });

  it('all deployable components default to helm: true', () => {
    // Both server and webapp defaults should have helm: true
    // to ensure charts are generated by default
    const serverMatch = content.match(/DEFAULT_API_SERVER_SETTINGS[\s\S]*?helm:\s*true/);
    const webappMatch = content.match(/DEFAULT_WEBAPP_SETTINGS[\s\S]*?helm:\s*true/);
    expect(serverMatch).not.toBeNull();
    expect(webappMatch).not.toBeNull();
  });

  it('database defaults to non-dedicated (shared in local dev)', () => {
    expect(content).toContain('dedicated: false');
  });

  it('contract defaults to internal visibility', () => {
    expect(content).toContain("visibility: 'internal'");
  });
});
