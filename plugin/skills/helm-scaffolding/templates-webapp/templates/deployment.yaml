# Deployment for webapp (nginx serving static files with config injection)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "common.fullname" . }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "common.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "common.selectorLabels" . | nindent 8 }}
      annotations:
        # Force restart on config change
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
    spec:
      {{- include "common.imagePullSecrets" . | nindent 6 }}
      initContainers:
        # Inject config into index.html at deploy time
        - name: inject-config
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Copy static files to working volume
              cp -r {{ .Values.assets.path }}/* /app/
              # Replace __SDD_CONFIG__ placeholder with actual config JSON
              sed -i "s/__SDD_CONFIG__/$CONFIG_JSON/g" /app/index.html
          env:
            - name: CONFIG_JSON
              valueFrom:
                configMapKeyRef:
                  name: {{ include "common.fullname" . }}-config
                  key: config.json
          volumeMounts:
            - name: static-files
              mountPath: /app
            - name: original-files
              mountPath: {{ .Values.assets.path }}
              readOnly: true
      containers:
        - name: nginx
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          volumeMounts:
            - name: static-files
              mountPath: /usr/share/nginx/html
              readOnly: true
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
              readOnly: true
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      volumes:
        - name: static-files
          emptyDir: {}
        - name: original-files
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: {{ include "common.fullname" . }}-nginx
