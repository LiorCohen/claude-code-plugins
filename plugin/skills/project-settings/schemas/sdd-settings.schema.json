{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "SDD Settings",
  "description": "Schema for .sdd/sdd-settings.yaml â€” the project configuration file that drives scaffolding, config generation, and deployment.",
  "type": "object",
  "required": ["sdd", "project", "components"],
  "additionalProperties": false,
  "properties": {
    "sdd": {
      "type": "object",
      "description": "SDD plugin metadata.",
      "required": ["plugin_version", "initialized_at", "last_updated"],
      "additionalProperties": false,
      "properties": {
        "plugin_version": {
          "type": "string",
          "description": "SDD plugin version that created this project."
        },
        "initialized_at": {
          "type": "string",
          "format": "date",
          "description": "Date project was initialized (YYYY-MM-DD)."
        },
        "last_updated": {
          "type": "string",
          "format": "date",
          "description": "Date settings were last modified (YYYY-MM-DD)."
        }
      }
    },
    "project": {
      "type": "object",
      "description": "Project metadata.",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Project name (lowercase, hyphens, no spaces)."
        },
        "description": {
          "type": "string",
          "description": "Brief project description."
        },
        "domain": {
          "type": "string",
          "description": "Primary business domain."
        },
        "type": {
          "type": "string",
          "enum": ["fullstack", "backend", "frontend", "custom"],
          "description": "Project type classification."
        }
      }
    },
    "components": {
      "type": "array",
      "description": "List of project components. Must include exactly one config component.",
      "items": {
        "$ref": "#/$defs/component"
      }
    }
  },
  "$defs": {
    "component_name": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "description": "Lowercase, hyphens only. Should be multi-word and domain-specific (e.g., order-service, analytics-db)."
    },
    "component": {
      "type": "object",
      "required": ["name", "type", "settings"],
      "properties": {
        "name": { "$ref": "#/$defs/component_name" },
        "type": {
          "type": "string",
          "enum": ["config", "server", "webapp", "helm", "database", "contract", "testing", "cicd"]
        },
        "settings": { "type": "object" }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "config" } } },
          "then": {
            "properties": {
              "name": { "const": "config" },
              "settings": {
                "type": "object",
                "additionalProperties": false
              }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "server" } } },
          "then": {
            "properties": {
              "settings": { "$ref": "#/$defs/server_settings" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "webapp" } } },
          "then": {
            "properties": {
              "settings": { "$ref": "#/$defs/webapp_settings" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "helm" } } },
          "then": {
            "properties": {
              "settings": { "$ref": "#/$defs/helm_settings" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "database" } } },
          "then": {
            "properties": {
              "settings": { "$ref": "#/$defs/database_settings" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "contract" } } },
          "then": {
            "properties": {
              "settings": { "$ref": "#/$defs/contract_settings" }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "testing" } } },
          "then": {
            "properties": {
              "settings": {
                "type": "object",
                "additionalProperties": false
              }
            }
          }
        },
        {
          "if": { "properties": { "type": { "const": "cicd" } } },
          "then": {
            "properties": {
              "settings": {
                "type": "object",
                "additionalProperties": false
              }
            }
          }
        }
      ]
    },
    "server_settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "server_type": {
          "type": "string",
          "enum": ["api", "worker", "cron", "hybrid"],
          "default": "api",
          "description": "Communication pattern(s)."
        },
        "modes": {
          "type": "array",
          "items": { "type": "string", "enum": ["api", "worker", "cron"] },
          "minItems": 2,
          "description": "For hybrid: which modes (2+ required)."
        },
        "databases": {
          "type": "array",
          "items": { "$ref": "#/$defs/component_name" },
          "default": [],
          "description": "Database components this server uses. Must reference existing database components."
        },
        "provides_contracts": {
          "type": "array",
          "items": { "$ref": "#/$defs/component_name" },
          "default": [],
          "description": "Contracts this server implements. Must reference existing contract components."
        },
        "consumes_contracts": {
          "type": "array",
          "items": { "$ref": "#/$defs/component_name" },
          "default": [],
          "description": "Contracts this server calls. Must reference existing contract components."
        },
        "helm": {
          "type": "boolean",
          "default": true,
          "description": "Whether to generate a helm chart for this server."
        }
      },
      "if": {
        "properties": { "server_type": { "const": "hybrid" } }
      },
      "then": {
        "required": ["modes"]
      }
    },
    "webapp_settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "contracts": {
          "type": "array",
          "items": { "$ref": "#/$defs/component_name" },
          "default": [],
          "description": "Contracts this webapp uses. Must reference existing contract components."
        },
        "helm": {
          "type": "boolean",
          "default": true,
          "description": "Whether to generate a helm chart for this webapp."
        }
      }
    },
    "helm_settings": {
      "type": "object",
      "required": ["deploys", "deploy_type"],
      "additionalProperties": false,
      "properties": {
        "deploys": {
          "$ref": "#/$defs/component_name",
          "description": "Component to deploy. Must reference a component with helm: true."
        },
        "deploy_type": {
          "type": "string",
          "enum": ["server", "webapp"],
          "description": "Type of component being deployed."
        },
        "deploy_modes": {
          "type": "array",
          "items": { "type": "string", "enum": ["api", "worker", "cron"] },
          "description": "For servers: which modes to deploy. Must be a subset of the server's available modes."
        },
        "ingress": {
          "type": "boolean",
          "default": true,
          "description": "External HTTP access."
        },
        "assets": {
          "type": "string",
          "enum": ["bundled", "entrypoint"],
          "default": "bundled",
          "description": "For webapps: asset strategy."
        }
      }
    },
    "database_settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["postgresql"],
          "default": "postgresql",
          "description": "Database provider."
        },
        "dedicated": {
          "type": "boolean",
          "default": false,
          "description": "Whether this database needs its own DB server."
        }
      }
    },
    "contract_settings": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "visibility": {
          "type": "string",
          "enum": ["public", "internal"],
          "default": "internal",
          "description": "Whether external consumers are allowed."
        }
      }
    }
  }
}
